<%  layout("layouts/boilerplate")  -%>
<div class="container mt-4">
  <% if (currentUser) { %>
    <!-- Return currentUser ID for use when building  element -->
    <div id="current-user-id" data-id="<%= currentUser.id %>"></div>
<% } %>
<div class="text-center ml-4 mb-3" id="title">
  <h1><%=post.title%></h1>
</div>
  <div class="mb-4 details"> 
    <img src="<%= post.author.image.secure_url %>" alt="userimage" class="img-fluid ml-4 show-img">
    <span class="pl-2 author">by <a href="/user/<%= post.author._id%>"><%= post.author.username %></a></span>
    <span class="pl-3 time"><%= post.updatedAt.toDateString() %></span>
  </div>
  <!-- <div> -->
    <%  post.images.forEach(function(img){  %>
          <img src="<%= img.url  %>" width="100%" class="mb-2" class="img-fluid" alt="Preview not available">
      <% })  %>
      <div class="main-content">
      <%-post.description%>
    </div>
      <hr>
      <div class="pb-5  d-flex align-items-center justify-content-center like-edit">
        <% if( (currentUser && currentUser._id.equals(post.author._id)) || (currentUser && currentUser.isAdmin))  {%>
          <div class="dropdown px-5 mt-3">
            <span style="font-size: 55px;"><i class="fas fa-caret-down dropbtn crate"></i></span>
            <div class="dropdown-content">
              <a href="/post/<%=post._id%>/edit" style="color: black;" class="pl-2">Edit</a>
              <span class="form">
              <form action="/post/<%=post._id%>?_method=DELETE" method="POST" >
                <button class="form-submit-button">Delete</button>
              </form>   
              </span>    
            </div>
          </div>
        <%}%>
        <div>
        <form action="/post/<%= post._id %>/like" method="POST" id="like" >
            <div class="btn-group">
              <%  if(!currentUser){ %>
                <a class="form-submit-button mt-2" href="/login?returnTo=true"  style="font-size: 20px; color: red;">
                  <i class="far fa-heart"></i>
                </a>
               <% } else if(currentUser && post.likes.some(function (like) { return like.equals(currentUser._id) })) { %>
                    <button class="form-submit-button mt-2"  style="font-size: 20px;">
                      <i class="far fa-heart"></i>
                    </button>
                <% } else { %>
                    <button class="form-submit-button mt-2" style="font-size: 20px;">
                      <i class="far fa-heart"></i>
                    </button>
                <% } %>
                <button type="button"  class="form-submit-button mt-1 ml-4" data-toggle="modal"
                        data-target="#postLikes"><span class="float-right length" style="font-size: 18px;"><span id="count" ><%= post.likes.length %></span> PEOPLE LIKE IT</span>  
                </button>
            </div>
        </form>
      </div>
    </div>

    <div id="postLikes" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
              <div class="modal-header">
                  <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
                  <h4 class="modal-title">Post likes: <span class="length"><%= post.likes.length %></span></h4>
              </div>
              <div class="modal-body">
                  <table class="table table-striped" >
                      <thead>
                      <tr>
                          <th>Liked by:</th>
                      </tr>
                      </thead>
                      <tbody id="nolike">
                      <% if (post.likes.length === 0) { %>
                          <tr>
                              <td><em >No likes yet.</em></td>
                          </tr>
                      <% } %>
                      <% post.likes.forEach(function(like) { %>
                          <tr>
                              <td><img src="<%=like.image.secure_url %>"  alt="userimage" class="img-fluid show-img mr-3"> <%= like.username %></td>
                          </tr>
                      <% }); %>
                      </tbody>
                  </table>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>

      <!-- <hr> -->

    </div>
      <section class="detail-cont pt-4 pb-2">
     <% if(currentUser) {%>
      <div class="mb-3 opinion">
        <div class="container">
        <span class="pr-2 " style="font-family: 'Overpass', sans-serif;font-size: 15px;">Share Your Opinion as</span>
      <img src="<%= currentUser.image.secure_url %>"  alt="userimage" class="img-fluid show-img"  > 
      <div style="display: inline-block;" class="pl-2 userName font-weight-bold"><%= currentUser.username%></div>
    </div>
  </div>
     <%}%>
     <div class="container">
      <form action="/post/<%= post._id%>/comments" method="POST" id="comment">
        <div class="form-group">
      <textarea class="form-control" name="newcomment[comment]" placeholder="Leave your comment here" required cols="152" rows="5"></textarea>
    </div>
     <% if(currentUser){ %>
        <button  class="scroll-button py-1">Publish</button>
    <%  } else{%>
        <a href="/login?returnTo=true" class="scroll-button">Publish</a>
        <%}%>
      </form>
  <!-- </div> -->
  <hr>
  <% if(post.comments.length===0) {%>
    <style>
      #comment-container{
        display: none;
      }
      #nocomment{
        display: block;
      }
      </style>
    <%}else{%>
      <style>
        #nocomment{
        display: none;
      }
      </style>
    <%}%>
  <p id="nocomment" class="text-center mt-1">No comments yet be the first one to comment</p>
  <div id="comment-container">
    <%  post.comments.forEach(function(com){  %>
      <div id="<%=com._id%>" class="customcss">
      <div class="d-flex flex-row align-items-center" id="image"> 
        <div><img src="<%= com.author.image.secure_url %>" alt="userimage" class="img-fluid show-img"> </div>
      <div class="pl-4 mt-2 font-weight-bold" ><%= com.author.username%></div>
      <%if(currentUser && com.author._id.equals(currentUser._id)){%>
        <div class="dropdown ml-3 mt-2">
            <span style="font-size: 35px;"><i class="fas fa-caret-down dropbtn crate"></i></span>
            <div class="dropdown-content">
              <a style="color: black;" class="pl-2 edit-tag" data-id="<%=com._id%>" data-toggle="collapse" href="#collapseExample<%=com._id%>" role="button" aria-expanded="false" aria-controls="collapseExample<%=com._id%>">Edit</a>
              <form action="/post/<%=post._id%>/comments/<%=com._id%>?_method=DELETE" method="POST"  getid="<%=com._id%>">
                <button class="form-submit-button delete1" >Delete</button>
              </form>
            </div>
        </div>
        <%}%>
      </div>
      <div class="mt-4" id="com-content<%=com._id%>"><div class="container text-justify comment-value"><%= com.comment %></div><span class="float-right com-time"><%= moment(com.updatedAt).fromNow() %></span></div>   
     <hr> 
      <div class="collapse" id="collapseExample<%=com._id%>">
          <form action="/post/<%= post._id%>/comments/<%=com._id%>?_method=PUT" method="POST" id="<%=com._id%>" class="edit1">
            <div class="form-group">
            <textarea name="newcomment[comment]" class="form-control" id="message" required cols="152" rows="5"><%=com.comment%></textarea>
          </div>
            <button class="btn btn-success ">Publish</button>
            <a class="btn btn-primary" data-toggle="collapse" href="#collapseExample<%=com._id%>" role="button" aria-expanded="false" aria-controls="collapseExample">
              Close
            </a>
          </form>     
      </div>
    </div>
      <% })%>
</div>

<%if(post.comments && post.comments.length>0){%>
  <div class="pb-4 mt-4">
  <a href="/post/<%=post._id%>" id="showmore" data-page="2">Show more comments</a>
  </div>
<%}%>
</div>
</section>
<script src="/javascripts/jquery.js"></script>
<script>
  $("#comment-container").hover(function(){
    var edittag = document.querySelectorAll(".edit-tag");
    //console.log($edittag)
     edittag.forEach(function(add){
         $(add).unbind().on("click",function(c){
           var id =this.getAttribute("data-id");
           $(`#collapseExample${id}`).find("textarea").val($(`#com-content${id}`).find(".container").html())
           console.log(id);
         })
     })
  })
  
</script>